'use strict';

var superagent = require('superagent'),
    logger = require('../logging').getLogger({ "name": "react-server.core.ReactServerAgent.Request", "color": { "server": 85, "client": "rgb(42,212,127)" } }),
    Q = require('q'),
    Plugins = require("./Plugins"),
    merge = require("lodash/merge");

/**
 * Implements a subset of superagent's API. Packages up arguments
 * to pass to superagent under the hood.
 */
function Request(method, urlPath, cache) {
	this._method = method;
	this._urlPath = urlPath;
	this._cache = cache;

	this._queryParams = [];
	// _postParams should initially be null instead of {} because we want to allow people to send POST requests with
	// empty data sets (if they need to).  This way, we can differentiate between a default of null, an empty data set,
	// and a populated data set.
	this._postParams = null;
	this._headers = {};
	this._timeout = null;
	this._type = "json"; // superagent's default, only for POST/PUT/PATCH methods

	// public field
	this.aborted = undefined; //default to undefined
}

// we implement a subset of superagent's API. for the other methods,
// for now, we'll just throw an exception if they're called. By default,
// all methods throw exceptions, and we override some below
Object.keys(superagent.Request.prototype).forEach(function (propName) {
	var originalProp = superagent.Request.prototype[propName];
	if (typeof originalProp === 'function') {
		Request.prototype[propName] = function () {
			throw new Error(propName + '() from superagent\'s API isn\'t implemented yet.');
		};
	}
});

Request.prototype.agent = function (agent) {
	if (typeof agent === 'undefined') {
		return this._agent;
	}
	this._agent = agent;
	return this;
};

Request.prototype.method = function (method) {
	if (typeof method === 'undefined') {
		return this._method;
	}
	this._method = method;
	return this;
};

Request.prototype.urlPath = function (urlPath) {
	if (typeof urlPath === 'undefined') {
		return this._urlPath;
	}
	this._urlPath = urlPath;
	return this;
};

Request.prototype.query = function (queryParams) {
	if (typeof queryParams === 'undefined') {
		throw new Error("Request.query does not support retrieving the current query string");
	}
	this._queryParams.push(queryParams);
	return this;
};

Request.prototype.send = function (postParams) {
	if (typeof postParams === 'undefined') {
		return merge({}, this._postParams || {});
	}
	if (postParams !== null) {
		if (this._postParams === null) {
			this._postParams = {};
		}
		merge(this._postParams, postParams);
	}
	return this;
};

Request.prototype.set = function (headers) {
	if (typeof headers === 'undefined') {
		return merge({}, this._headers);
	}
	merge(this._headers, headers);
	return this;
};

Request.prototype.timeout = function (timeout) {
	if (typeof timeout === 'undefined') {
		return this._timeout;
	}
	this._timeout = timeout;
	return this;
};

Request.prototype.type = function (type) {
	if (typeof type === 'undefined') {
		return this._type;
	}
	this._type = type;
	return this;
};

Request.prototype.toJSON = function () {
	return {
		aborted: this.aborted,
		cacheWhitelist: this._cacheWhitelist,
		headers: this._headers,
		method: this._method,
		postParams: this._postParams,
		queryParams: this._queryParams,
		timeout: this._timeout,
		type: this._type,
		urlPath: this._urlPath
	};
};

/**
 * Wrap superagent's end() method to create an entry in a request-local
 * data cache that will be serialized to the client and replayed in the
 * browser.
 */
Request.prototype.end = function (fn) {

	if (!fn || fn.length !== 2) {
		// a superagent requirement, as of ~v1.0; We're providing a default callback here.
		fn = function fn(a, b) {}; // eslint-disable-line no-unused-vars
	}

	var executeRequest = function (cb) {
		applyRequestPlugins(this);

		// set up some params
		var saRequest = buildSuperagentRequest.call(this);

		// actually execute the request via superagent
		superagent.Request.prototype.end.call(saRequest, cb);

		return this;
	}.bind(this);

	// helper, for cleaner code below
	var wrapResponseCallback = responsePluginApplyingCallback.bind(this);

	// only do caching for responses for GET requests for now
	if (this._method !== 'GET') {
		return executeRequest(wrapResponseCallback(fn));
	}

	// get cache entry for url if exists; if server-side, create one if it doesn't already exist.
	// the cache key here needs to be the same server-side and client-side, so the full URL, complete
	// with host (which can vary between client and server) is not usable. The URL path (without the
	// host) works fine though.
	var entry = this._cache.entry(this._getCacheAffectingData(), true /* createIfMissing */, this._cacheWhitelist);
	if (!true && !entry) {
		return executeRequest(wrapResponseCallback(fn));
	}

	// no previous requesters? fire the request
	if (entry.requesters === 0) {
		executeRequest(function (err, res) {
			if (err) {
				entry.setError(err);
				return;
			}
			entry.setResponse(res);
		});
	}

	entry.whenDataReady().nodeify(wrapResponseCallback(fn));

	return this;
};

// private function
function applyRequestPlugins(req) {
	// run any registered plugins
	Plugins.forRequest().asArray().forEach(function (pluginFunc) {
		pluginFunc.apply(null, [req]);
	});
}

// private function; called with a Request instance bound to
// `this`
function responsePluginApplyingCallback(cb) {
	// partly pedantic, partly so the code in the wrapped callback
	// is shorter; saving plugins here guarantees that plugins added
	// *after* the request is made, but *before* the response comes
	// aren't called for this particular request
	var thisReq = this;
	var plugins = Plugins.forResponse().asArray();
	return function (err, res) {
		plugins.forEach(function (pluginFunc) {
			pluginFunc.apply(null, [err, res, thisReq]);
		});
		cb(err, res);
	};
}

// private function; called with a Request instance bound
// to `this`
function buildSuperagentRequest() {
	var req = superagent(this._method, this._buildUrl());

	if (this._agent) {
		req.agent(this._agent);
	}

	req.set(this._headers);

	this._queryParams.forEach(function (params) {
		return req.query(params);
	});

	var postParams = this._postParams;

	// convert params to FormData if the request type is form-data
	if (this._type === "form-data") {
		if (!true) {
			var formData = new FormData();
			if (postParams) {
				var paramKeys = Object.keys(postParams);
				paramKeys.forEach(function (key) {
					formData.append(key, postParams[key]);
				});
			}
			postParams = formData;
		} else {
			throw new Error('ReactServerAgent.type("form-data") not allowed server-side');
		}
	}

	// query parameters exist if there are more than one set
	// post parameters exist if the value is not null
	var hasQueryParams = this._queryParams.length > 0,
	    hasPostParams = this._postParams !== null;

	if (hasPostParams) {
		// superagent has some weird, implicit file upload support
		// that only works if you don't set `type`.
		if (this._type && this._type !== 'form-data') {
			req.type(this._type);
		}

		req.send(postParams);
	}

	switch (this._method) {
		case 'GET':
		case 'HEAD':
			if (hasPostParams) {
				logger.warning('Attempting a ' + this._method + ' request with POST data (using SuperAgent\'s .send() function). This might result in a CORS preflight request');
			}
			break;

		case 'POST':
		case 'PATCH':
		case 'PUT':
			if (hasQueryParams) {
				logger.info('Attempting a ' + this._method + ' request with query data (using SuperAgent\'s .query() function). This might not be what you want.');
			}
			break;
	}

	if (this._timeout) {
		req.timeout(this._timeout);
	}

	// cache the internal request, so that we can cancel it
	// if necessary (see: `abort()`)
	this._superagentReq = req;

	return req;
}

Request.prototype._buildUrl = function () {
	// only modify relative paths
	if (this._urlPrefix && this._urlPath.charAt(0) === '/') {
		return this._urlPrefix + this._urlPath;
	}
	return this._urlPath;
};

Request.prototype._getCacheAffectingData = function () {
	return {
		urlPath: this._urlPath,
		method: this._method,
		queryParams: this._queryParams,
		postParams: this._postParams,
		// headers: this._headers, // headers are not included
		type: this._type
	};
};

Request.prototype.getProtocol = function () {

	// Returns undefined if no protocol found.
	return (this._buildUrl().match(/^(.+?):/) || [])[1];
};

/**
 * Convenience method to treat the request as then-able (promise-like).
 * This is shorthand for the simple case. If you want access to the full
 * power of the underlying promise library, use `Request.asPromise()`
 */
Request.prototype.then = function () /*arguments*/{
	var promise = this.asPromise();
	return promise.then.apply(promise, arguments);
};

/**
 * Convenience method wrapping `.end()` and returning a promise
 * that is resolved if the request is successful, and rejected if
 * the request results in an error.
 */
Request.prototype.asPromise = function () {
	var dfd = Q.defer();
	dfd.promise.catch(logRequestError.bind(this));
	this.end(dfd.makeNodeResolver());
	return dfd.promise;
};

// private method; 'this' bound to request object
function logRequestError(err) {
	var response = err.response;

	if (!response) {
		logger.warning('ReactServerAgent raised exception for URL ' + this._urlPath, err);
	} else if (response.notFound) {
		// 404? don't care about response
		logger.warning('Resource not found on server: ' + this._urlPath);
	} else if (response.serverError) {
		logger.warning('Received server error for URL ' + this._urlPath, err);
	} else {
		logger.warning('Unexpected status code returned for URL ' + this._urlPath, err);
	}
}

/**
 * Overriding superagent use() function to give a more descriptive
 * error message than just not including it altogether.
 */
Request.prototype.use = function () {
	throw new Error('use() function is superseded by plugRequest(...)');
};

/**
 * Get/Set the prefix used for relative URLs
 */
Request.prototype.urlPrefix = function (urlPrefix) {
	if (typeof urlPrefix === 'undefined') {
		return this._urlPrefix;
	}
	this._urlPrefix = urlPrefix;
	return this;
};

/**
 * Abort the active request. Passes through to superagent's
 * `abort()` method. Sets 'aborted' flag on this request
 */
Request.prototype.abort = function () {
	if (this._superagentReq) {
		this.aborted = true;
		this._superagentReq.abort();
	}
	return this;
};

/**
 * Enables saving the 'header' property in the response cache.
 * This is disabled by default to save space in the cache.
 */
Request.prototype.withHeaderInResponse = function () {
	if (typeof this._cacheWhitelist === 'undefined') {
		this._cacheWhitelist = [];
	}
	this._cacheWhitelist.push('header');
	return this;
};

module.exports = Request;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlYWN0U2VydmVyQWdlbnQvUmVxdWVzdC5qcyJdLCJuYW1lcyI6WyJzdXBlcmFnZW50IiwicmVxdWlyZSIsImxvZ2dlciIsImdldExvZ2dlciIsIlEiLCJQbHVnaW5zIiwibWVyZ2UiLCJSZXF1ZXN0IiwibWV0aG9kIiwidXJsUGF0aCIsImNhY2hlIiwiX21ldGhvZCIsIl91cmxQYXRoIiwiX2NhY2hlIiwiX3F1ZXJ5UGFyYW1zIiwiX3Bvc3RQYXJhbXMiLCJfaGVhZGVycyIsIl90aW1lb3V0IiwiX3R5cGUiLCJhYm9ydGVkIiwidW5kZWZpbmVkIiwiT2JqZWN0Iiwia2V5cyIsInByb3RvdHlwZSIsImZvckVhY2giLCJvcmlnaW5hbFByb3AiLCJwcm9wTmFtZSIsIkVycm9yIiwiYWdlbnQiLCJfYWdlbnQiLCJxdWVyeSIsInF1ZXJ5UGFyYW1zIiwicHVzaCIsInNlbmQiLCJwb3N0UGFyYW1zIiwic2V0IiwiaGVhZGVycyIsInRpbWVvdXQiLCJ0eXBlIiwidG9KU09OIiwiY2FjaGVXaGl0ZWxpc3QiLCJfY2FjaGVXaGl0ZWxpc3QiLCJlbmQiLCJmbiIsImxlbmd0aCIsImEiLCJiIiwiZXhlY3V0ZVJlcXVlc3QiLCJjYiIsImFwcGx5UmVxdWVzdFBsdWdpbnMiLCJzYVJlcXVlc3QiLCJidWlsZFN1cGVyYWdlbnRSZXF1ZXN0IiwiY2FsbCIsImJpbmQiLCJ3cmFwUmVzcG9uc2VDYWxsYmFjayIsInJlc3BvbnNlUGx1Z2luQXBwbHlpbmdDYWxsYmFjayIsImVudHJ5IiwiX2dldENhY2hlQWZmZWN0aW5nRGF0YSIsInJlcXVlc3RlcnMiLCJlcnIiLCJyZXMiLCJzZXRFcnJvciIsInNldFJlc3BvbnNlIiwid2hlbkRhdGFSZWFkeSIsIm5vZGVpZnkiLCJyZXEiLCJmb3JSZXF1ZXN0IiwiYXNBcnJheSIsInBsdWdpbkZ1bmMiLCJhcHBseSIsInRoaXNSZXEiLCJwbHVnaW5zIiwiZm9yUmVzcG9uc2UiLCJfYnVpbGRVcmwiLCJwYXJhbXMiLCJmb3JtRGF0YSIsIkZvcm1EYXRhIiwicGFyYW1LZXlzIiwiYXBwZW5kIiwia2V5IiwiaGFzUXVlcnlQYXJhbXMiLCJoYXNQb3N0UGFyYW1zIiwid2FybmluZyIsImluZm8iLCJfc3VwZXJhZ2VudFJlcSIsIl91cmxQcmVmaXgiLCJjaGFyQXQiLCJnZXRQcm90b2NvbCIsIm1hdGNoIiwidGhlbiIsInByb21pc2UiLCJhc1Byb21pc2UiLCJhcmd1bWVudHMiLCJkZmQiLCJkZWZlciIsImNhdGNoIiwibG9nUmVxdWVzdEVycm9yIiwibWFrZU5vZGVSZXNvbHZlciIsInJlc3BvbnNlIiwibm90Rm91bmQiLCJzZXJ2ZXJFcnJvciIsInVzZSIsInVybFByZWZpeCIsImFib3J0Iiwid2l0aEhlYWRlckluUmVzcG9uc2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLGFBQWFDLFFBQVEsWUFBUixDQUFqQjtBQUFBLElBQ0VDLFNBQVNELFFBQVEsWUFBUixFQUFzQkUsU0FBdEIsQ0FBZ0MsRUFBQyxRQUFPLDRDQUFSLEVBQXFELFNBQVEsRUFBQyxVQUFTLEVBQVYsRUFBYSxVQUFTLGlCQUF0QixFQUE3RCxFQUFoQyxDQURYO0FBQUEsSUFFRUMsSUFBSUgsUUFBUSxHQUFSLENBRk47QUFBQSxJQUdFSSxVQUFVSixRQUFRLFdBQVIsQ0FIWjtBQUFBLElBSUVLLFFBQVFMLFFBQVEsY0FBUixDQUpWOztBQU9BOzs7O0FBSUEsU0FBU00sT0FBVCxDQUFpQkMsTUFBakIsRUFBeUJDLE9BQXpCLEVBQWtDQyxLQUFsQyxFQUF5QztBQUN4QyxNQUFLQyxPQUFMLEdBQWVILE1BQWY7QUFDQSxNQUFLSSxRQUFMLEdBQWdCSCxPQUFoQjtBQUNBLE1BQUtJLE1BQUwsR0FBY0gsS0FBZDs7QUFFQSxNQUFLSSxZQUFMLEdBQW9CLEVBQXBCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsTUFBS0MsV0FBTCxHQUFtQixJQUFuQjtBQUNBLE1BQUtDLFFBQUwsR0FBZ0IsRUFBaEI7QUFDQSxNQUFLQyxRQUFMLEdBQWdCLElBQWhCO0FB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QUF2QjtBQUNBO0FBQ0QsTUFBS0EsZUFBTCxDQUFxQlQsSUFBckIsQ0FBMEIsUUFBMUI7QUFDQSxRQUFPLElBQVA7QUFDQSxDQU5EOztBQVNBeUUsT0FBT0MsT0FBUCxHQUFpQm5HLE9BQWpCIiwiZmlsZSI6IlJlYWN0U2VydmVyQWdlbnQvUmVxdWVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBzdXBlcmFnZW50ID0gcmVxdWlyZSgnc3VwZXJhZ2VudCcpXG4sXHRsb2dnZXIgPSByZXF1aXJlKCcuLi9sb2dnaW5nJykuZ2V0TG9nZ2VyKHtcIm5hbWVcIjpcInJlYWN0LXNlcnZlci5jb3JlLlJlYWN0U2VydmVyQWdlbnQuUmVxdWVzdFwiLFwiY29sb3JcIjp7XCJzZXJ2ZXJcIjo4NSxcImNsaWVudFwiOlwicmdiKDQyLDIxMiwxMjcpXCJ9fSlcbixcdFEgPSByZXF1aXJlKCdxJylcbixcdFBsdWdpbnMgPSByZXF1aXJlKFwiLi9QbHVnaW5zXCIpXG4sXHRtZXJnZSA9IHJlcXVpcmUoXCJsb2Rhc2gvbWVyZ2VcIilcbjtcblxuLyoqXG4gKiBJbXBsZW1lbnRzIGEgc3Vic2V0IG9mIHN1cGVyYWdlbnQncyBBUEkuIFBhY2thZ2VzIHVwIGFyZ3VtZW50c1xuICogdG8gcGFzcyB0byBzdXBlcmFnZW50IHVuZGVyIHRoZSBob29kLlxuICovXG5mdW5jdGlvbiBSZXF1ZXN0KG1ldGhvZCwgdXJsUGF0aCwgY2FjaGUpIHtcblx0dGhpcy5fbWV0aG9kID0gbWV0aG9kO1xuXHR0aGlzLl91cmxQYXRoID0gdXJsUGF0aDtcblx0dGhpcy5fY2FjaGUgPSBjYWNoZTtcblxuXHR0aGlzLl9xdWVyeVBhcmFtcyA9IFtdO1xuXHQvLyBfcG9zdFBhcmFtcyBzaG91bGQgaW5pdGlhbGx5IGJlIG51bGwgaW5zdGVhZCBvZiB7fSBiZWNhdXNlIHdlIHdhbnQgdG8gYWxsb3cgcGVvcGxlIHRvIHNlbmQgUE9TVCByZXF1ZXN0cyB3aXRoXG5cdC8vIGVtcHR5IGRhdGEgc2V0cyAoaWYgdGhleSBuZWVkIHRvKS4gIFRoaXMgd2F5LCB3ZSBjYW4gZGlmZmVyZW50aWF0ZSBiZXR3ZWVuIGEgZGVmYXVsdCBvZiBudWxsLCBhbiBlbXB0eSBkYXRhIHNldCxcblx0Ly8gYW5kIGEgcG9wdWxhdGVkIGRhdGEgc2V0LlxuXHR0aGlzLl9wb3N0UGFyYW1zID0gbnVsbDtcblx0dGhpcy5faGVhZGVycyA9IHt9O1xuXHR0aGlzLl90aW1lb3V0ID0gbnVsbDtcblx0dGhpcy5fdHlwZSA9IFwianNvblwiOyAvLyBzdXBlcmFnZW50J3MgZGVmYXVsdCwgb25seSBmb3IgUE9TVC9QVVQvUEFUQ0ggbWV0aG9kc1xuXG5cdC8vIHB1YmxpYyBmaWVsZFxuXHR0aGlzLmFib3J0ZWQgPSB1bmRlZmluZWQ7IC8vZGVmYXVsdCB0byB1bmRlZmluZWRcbn1cblxuLy8gd2UgaW1wbGVtZW50IGEgc3Vic2V0IG9mIHN1cGVyYWdlbnQncyBBUEkuIGZvciB0aGUgb3RoZXIgbWV0aG9kcyxcbi8vIGZvciBub3csIHdlJ2xsIGp1c3QgdGhyb3cgYW4gZXhjZXB0aW9uIGlmIHRoZXkncmUgY2FsbGVkLiBCeSBkZWZhdWx0LFxuLy8gYWxsIG1ldGhvZHMgdGhyb3cgZXhjZXB0aW9ucywgYW5kIHdlIG92ZXJyaWRlIHNvbWUgYmVsb3dcbk9iamVjdC5rZXlzKHN1cGVyYWdlbnQuUmVxdWVzdC5wcm90b3R5cGUpXG5cdC5mb3JFYWNoKCBwcm9wTmFtZSA9PiB7XG5cdFx0dmFyIG9yaWdpbmFsUHJvcCA9IHN1cGVyYWdlbnQuUmVxdWVzdC5wcm90b3R5cGVbcHJvcE5hbWVdO1xuXHRcdGlmICh0eXBlb2Ygb3JpZ2luYWxQcm9wID09PSAnZnVuY3Rpb24nKSB7XG5cdFx0XHRSZXF1ZXN0LnByb3RvdHlwZVtwcm9wTmFtZV0gPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgJHtwcm9wTmFtZX0oKSBmcm9tIHN1cGVyYWdlbnQncyBBUEkgaXNuJ3QgaW1wbGVtZW50ZWQgeWV0LmApO1xuXHRcdFx0fVxuXHRcdH1cblx0fSk7XG5cblJlcXVlc3QucHJvdG90eXBlLmFnZW50ID0gZnVuY3Rpb24gKGFnZW50KSB7XG5cdGlmICh0eXBlb2YgYWdlbnQgPT09ICd1bmRlZmluZWQnKSB7XG5cdFx0cmV0dXJuIHRoaXMuX2FnZW50O1xuXHR9XG5cdHRoaXMuX2FnZW50ID0gYWdlbnQ7XG5cdHJldHVybiB0aGlzO1xufVxuXG5SZXF1ZXN0LnByb3RvdHlwZS5tZXRob2QgPSBmdW5jdGlvbiAobWV0aG9kKSB7XG5cdGlmICh0eXBlb2YgbWV0aG9kID09PSAndW5kZWZpbmVkJykge1xuXHRcdHJldHVybiB0aGlzLl9tZXRob2Q7XG5cdH1cblx0dGhpcy5fbWV0aG9kID0gbWV0aG9kO1xuXHRyZXR1cm4gdGhpcztcbn1cblxuUmVxdWVzdC5wcm90b3R5cGUudXJsUGF0aCA9IGZ1bmN0aW9uICh1cmxQYXRoKSB7XG5cdGlmICh0eXBlb2YgdXJsUGF0aCA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRyZXR1cm4gdGhpcy5fdXJsUGF0aDtcblx0fVxuXHR0aGlzLl91cmxQYXRoID0gdXJsUGF0aDtcblx0cmV0dXJuIHRoaXM7XG59XG5cblJlcXVlc3QucHJvdG90eXBlLnF1ZXJ5ID0gZnVuY3Rpb24gKHF1ZXJ5UGFyYW1zKSB7XG5cdGlmICh0eXBlb2YgcXVlcnlQYXJhbXMgPT09ICd1bmRlZmluZWQnKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiUmVxdWVzdC5xdWVyeSBkb2VzIG5vdCBzdXBwb3J0IHJldHJpZXZpbmcgdGhlIGN1cnJlbnQgcXVlcnkgc3RyaW5nXCIpO1xuXHR9XG5cdHRoaXMuX3F1ZXJ5UGFyYW1zLnB1c2gocXVlcnlQYXJhbXMpO1xuXHRyZXR1cm4gdGhpcztcbn1cblxuUmVxdWVzdC5wcm90b3R5cGUuc2VuZCA9IGZ1bmN0aW9uIChwb3N0UGFyYW1zKSB7XG5cdGlmICh0eXBlb2YgcG9zdFBhcmFtcyA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRyZXR1cm4gbWVyZ2Uoe30sIHRoaXMuX3Bvc3RQYXJhbXMgfHwge30pO1xuXHR9XG5cdGlmIChwb3N0UGFyYW1zICE9PSBudWxsKSB7XG5cdFx0aWYgKHRoaXMuX3Bvc3RQYXJhbXMgPT09IG51bGwpIHtcblx0XHRcdHRoaXMuX3Bvc3RQYXJhbXMgPSB7fTtcblx0XHR9XG5cdFx0bWVyZ2UodGhpcy5fcG9zdFBhcmFtcywgcG9zdFBhcmFtcyk7XG5cdH1cblx0cmV0dXJuIHRoaXM7XG59XG5cblJlcXVlc3QucHJvdG90eXBlLnNldCA9IGZ1bmN0aW9uIChoZWFkZXJzKSB7XG5cdGlmICh0eXBlb2YgaGVhZGVycyA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRyZXR1cm4gbWVyZ2Uoe30sIHRoaXMuX2hlYWRlcnMpO1xuXHR9XG5cdG1lcmdlKHRoaXMuX2hlYWRlcnMsIGhlYWRlcnMpO1xuXHRyZXR1cm4gdGhpcztcbn1cblxuUmVxdWVzdC5wcm90b3R5cGUudGltZW91dCA9IGZ1bmN0aW9uICh0aW1lb3V0KSB7XG5cdGlmICh0eXBlb2YgdGltZW91dCA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRyZXR1cm4gdGhpcy5fdGltZW91dDtcblx0fVxuXHR0aGlzLl90aW1lb3V0ID0gdGltZW91dDtcblx0cmV0dXJuIHRoaXM7XG59XG5cblJlcXVlc3QucHJvdG90eXBlLnR5cGUgPSBmdW5jdGlvbiAodHlwZSkge1xuXHRpZiAodHlwZW9mIHR5cGUgPT09ICd1bmRlZmluZWQnKSB7XG5cdFx0cmV0dXJuIHRoaXMuX3R5cGU7XG5cdH1cblx0dGhpcy5fdHlwZSA9IHR5cGU7XG5cdHJldHVybiB0aGlzO1xufVxuXG5SZXF1ZXN0LnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbigpe1xuXHRyZXR1cm4ge1xuXHRcdGFib3J0ZWQ6IHRoaXMuYWJvcnRlZCxcblx0XHRjYWNoZVdoaXRlbGlzdDogdGhpcy5fY2FjaGVXaGl0ZWxpc3QsXG5cdFx0aGVhZGVyczogdGhpcy5faGVhZGVycyxcblx0XHRtZXRob2Q6IHRoaXMuX21ldGhvZCxcblx0XHRwb3N0UGFyYW1zOiB0aGlzLl9wb3N0UGFyYW1zLFxuXHRcdHF1ZXJ5UGFyYW1zOiB0aGlzLl9xdWVyeVBhcmFtcyxcblx0XHR0aW1lb3V0OiB0aGlzLl90aW1lb3V0LFxuXHRcdHR5cGU6IHRoaXMuX3R5cGUsXG5cdFx0dXJsUGF0aDogdGhpcy5fdXJsUGF0aCxcblx0fTtcbn1cblxuLyoqXG4gKiBXcmFwIHN1cGVyYWdlbnQncyBlbmQoKSBtZXRob2QgdG8gY3JlYXRlIGFuIGVudHJ5IGluIGEgcmVxdWVzdC1sb2NhbFxuICogZGF0YSBjYWNoZSB0aGF0IHdpbGwgYmUgc2VyaWFsaXplZCB0byB0aGUgY2xpZW50IGFuZCByZXBsYXllZCBpbiB0aGVcbiAqIGJyb3dzZXIuXG4gKi9cblJlcXVlc3QucHJvdG90eXBlLmVuZCA9IGZ1bmN0aW9uIChmbikge1xuXG5cdGlmICghZm4gfHwgZm4ubGVuZ3RoICE9PSAyKSB7XG5cdFx0Ly8gYSBzdXBlcmFnZW50IHJlcXVpcmVtZW50LCBhcyBvZiB+djEuMDsgV2UncmUgcHJvdmlkaW5nIGEgZGVmYXVsdCBjYWxsYmFjayBoZXJlLlxuXHRcdGZuID0gKGEsIGIpID0+IHt9OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzXG5cdH1cblxuXHR2YXIgZXhlY3V0ZVJlcXVlc3QgPSBmdW5jdGlvbiAoY2IpIHtcblx0XHRhcHBseVJlcXVlc3RQbHVnaW5zKHRoaXMpO1xuXG5cdFx0Ly8gc2V0IHVwIHNvbWUgcGFyYW1zXG5cdFx0dmFyIHNhUmVxdWVzdCA9IGJ1aWxkU3VwZXJhZ2VudFJlcXVlc3QuY2FsbCh0aGlzKTtcblxuXHRcdC8vIGFjdHVhbGx5IGV4ZWN1dGUgdGhlIHJlcXVlc3QgdmlhIHN1cGVyYWdlbnRcblx0XHRzdXBlcmFnZW50LlJlcXVlc3QucHJvdG90eXBlLmVuZC5jYWxsKHNhUmVxdWVzdCwgY2IpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH0uYmluZCh0aGlzKTtcblxuXHQvLyBoZWxwZXIsIGZvciBjbGVhbmVyIGNvZGUgYmVsb3dcblx0dmFyIHdyYXBSZXNwb25zZUNhbGxiYWNrID0gcmVzcG9uc2VQbHVnaW5BcHBseWluZ0NhbGxiYWNrLmJpbmQodGhpcyk7XG5cblx0Ly8gb25seSBkbyBjYWNoaW5nIGZvciByZXNwb25zZXMgZm9yIEdFVCByZXF1ZXN0cyBmb3Igbm93XG5cdGlmICh0aGlzLl9tZXRob2QgIT09ICdHRVQnKSB7XG5cdFx0cmV0dXJuIGV4ZWN1dGVSZXF1ZXN0KHdyYXBSZXNwb25zZUNhbGxiYWNrKGZuKSk7XG5cdH1cblxuXHQvLyBnZXQgY2FjaGUgZW50cnkgZm9yIHVybCBpZiBleGlzdHM7IGlmIHNlcnZlci1zaWRlLCBjcmVhdGUgb25lIGlmIGl0IGRvZXNuJ3QgYWxyZWFkeSBleGlzdC5cblx0Ly8gdGhlIGNhY2hlIGtleSBoZXJlIG5lZWRzIHRvIGJlIHRoZSBzYW1lIHNlcnZlci1zaWRlIGFuZCBjbGllbnQtc2lkZSwgc28gdGhlIGZ1bGwgVVJMLCBjb21wbGV0ZVxuXHQvLyB3aXRoIGhvc3QgKHdoaWNoIGNhbiB2YXJ5IGJldHdlZW4gY2xpZW50IGFuZCBzZXJ2ZXIpIGlzIG5vdCB1c2FibGUuIFRoZSBVUkwgcGF0aCAod2l0aG91dCB0aGVcblx0Ly8gaG9zdCkgd29ya3MgZmluZSB0aG91Z2guXG5cdHZhciBlbnRyeSA9IHRoaXMuX2NhY2hlLmVudHJ5KHRoaXMuX2dldENhY2hlQWZmZWN0aW5nRGF0YSgpLCB0cnVlIC8qIGNyZWF0ZUlmTWlzc2luZyAqLywgdGhpcy5fY2FjaGVXaGl0ZWxpc3QpO1xuXHRpZiAoIXRydWUgJiYgIWVudHJ5KSB7XG5cdFx0cmV0dXJuIGV4ZWN1dGVSZXF1ZXN0KHdyYXBSZXNwb25zZUNhbGxiYWNrKGZuKSk7XG5cdH1cblxuXHQvLyBubyBwcmV2aW91cyByZXF1ZXN0ZXJzPyBmaXJlIHRoZSByZXF1ZXN0XG5cdGlmIChlbnRyeS5yZXF1ZXN0ZXJzID09PSAwKSB7XG5cdFx0ZXhlY3V0ZVJlcXVlc3QoZnVuY3Rpb24gKGVyciwgcmVzKSB7XG5cdFx0XHRpZiAoZXJyKSB7XG5cdFx0XHRcdGVudHJ5LnNldEVycm9yKGVycik7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblx0XHRcdGVudHJ5LnNldFJlc3BvbnNlKHJlcyk7XG5cdFx0fSk7XG5cdH1cblxuXHRlbnRyeS53aGVuRGF0YVJlYWR5KCkubm9kZWlmeSh3cmFwUmVzcG9uc2VDYWxsYmFjayhmbikpO1xuXG5cdHJldHVybiB0aGlzO1xufVxuXG4vLyBwcml2YXRlIGZ1bmN0aW9uXG5mdW5jdGlvbiBhcHBseVJlcXVlc3RQbHVnaW5zIChyZXEpIHtcblx0Ly8gcnVuIGFueSByZWdpc3RlcmVkIHBsdWdpbnNcblx0UGx1Z2lucy5mb3JSZXF1ZXN0KCkuYXNBcnJheSgpLmZvckVhY2goZnVuY3Rpb24gKHBsdWdpbkZ1bmMpIHtcblx0XHRwbHVnaW5GdW5jLmFwcGx5KG51bGwsIFtyZXFdKTtcblx0fSlcbn1cblxuLy8gcHJpdmF0ZSBmdW5jdGlvbjsgY2FsbGVkIHdpdGggYSBSZXF1ZXN0IGluc3RhbmNlIGJvdW5kIHRvXG4vLyBgdGhpc2BcbmZ1bmN0aW9uIHJlc3BvbnNlUGx1Z2luQXBwbHlpbmdDYWxsYmFjayhjYikge1xuXHQvLyBwYXJ0bHkgcGVkYW50aWMsIHBhcnRseSBzbyB0aGUgY29kZSBpbiB0aGUgd3JhcHBlZCBjYWxsYmFja1xuXHQvLyBpcyBzaG9ydGVyOyBzYXZpbmcgcGx1Z2lucyBoZXJlIGd1YXJhbnRlZXMgdGhhdCBwbHVnaW5zIGFkZGVkXG5cdC8vICphZnRlciogdGhlIHJlcXVlc3QgaXMgbWFkZSwgYnV0ICpiZWZvcmUqIHRoZSByZXNwb25zZSBjb21lc1xuXHQvLyBhcmVuJ3QgY2FsbGVkIGZvciB0aGlzIHBhcnRpY3VsYXIgcmVxdWVzdFxuXHR2YXIgdGhpc1JlcSA9IHRoaXM7XG5cdHZhciBwbHVnaW5zID0gUGx1Z2lucy5mb3JSZXNwb25zZSgpLmFzQXJyYXkoKTtcblx0cmV0dXJuIGZ1bmN0aW9uIChlcnIsIHJlcykge1xuXHRcdHBsdWdpbnMuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luRnVuYykge1xuXHRcdFx0cGx1Z2luRnVuYy5hcHBseShudWxsLCBbZXJyLCByZXMsIHRoaXNSZXFdKTtcblx0XHR9KTtcblx0XHRjYihlcnIsIHJlcyk7XG5cdH1cbn1cblxuLy8gcHJpdmF0ZSBmdW5jdGlvbjsgY2FsbGVkIHdpdGggYSBSZXF1ZXN0IGluc3RhbmNlIGJvdW5kXG4vLyB0byBgdGhpc2BcbmZ1bmN0aW9uIGJ1aWxkU3VwZXJhZ2VudFJlcXVlc3QoKSB7XG5cdHZhciByZXEgPSBzdXBlcmFnZW50KHRoaXMuX21ldGhvZCwgdGhpcy5fYnVpbGRVcmwoKSk7XG5cblx0aWYgKHRoaXMuX2FnZW50KXtcblx0XHRyZXEuYWdlbnQodGhpcy5fYWdlbnQpO1xuXHR9XG5cblx0cmVxLnNldCh0aGlzLl9oZWFkZXJzKTtcblxuXHR0aGlzLl9xdWVyeVBhcmFtcy5mb3JFYWNoKHBhcmFtcyA9PiByZXEucXVlcnkocGFyYW1zKSk7XG5cblx0dmFyIHBvc3RQYXJhbXMgPSB0aGlzLl9wb3N0UGFyYW1zO1xuXG5cdC8vIGNvbnZlcnQgcGFyYW1zIHRvIEZvcm1EYXRhIGlmIHRoZSByZXF1ZXN0IHR5cGUgaXMgZm9ybS1kYXRhXG5cdGlmICh0aGlzLl90eXBlID09PSBcImZvcm0tZGF0YVwiKSB7XG5cdFx0aWYgKCF0cnVlKSB7XG5cdFx0XHR2YXIgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcblx0XHRcdGlmIChwb3N0UGFyYW1zKSB7XG5cdFx0XHRcdHZhciBwYXJhbUtleXMgPSBPYmplY3Qua2V5cyhwb3N0UGFyYW1zKTtcblx0XHRcdFx0cGFyYW1LZXlzLmZvckVhY2goa2V5ID0+IHtcblx0XHRcdFx0XHRmb3JtRGF0YS5hcHBlbmQoa2V5LCBwb3N0UGFyYW1zW2tleV0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHRcdHBvc3RQYXJhbXMgPSBmb3JtRGF0YTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IEVycm9yKGBSZWFjdFNlcnZlckFnZW50LnR5cGUoXCJmb3JtLWRhdGFcIikgbm90IGFsbG93ZWQgc2VydmVyLXNpZGVgKTtcblx0XHR9XG5cdH1cblxuXHQvLyBxdWVyeSBwYXJhbWV0ZXJzIGV4aXN0IGlmIHRoZXJlIGFyZSBtb3JlIHRoYW4gb25lIHNldFxuXHQvLyBwb3N0IHBhcmFtZXRlcnMgZXhpc3QgaWYgdGhlIHZhbHVlIGlzIG5vdCBudWxsXG5cdGNvbnN0IGhhc1F1ZXJ5UGFyYW1zID0gKHRoaXMuX3F1ZXJ5UGFyYW1zLmxlbmd0aCA+IDApLFxuXHRcdGhhc1Bvc3RQYXJhbXMgPSAodGhpcy5fcG9zdFBhcmFtcyAhPT0gbnVsbCk7XG5cblx0aWYgKGhhc1Bvc3RQYXJhbXMpIHtcblx0XHQvLyBzdXBlcmFnZW50IGhhcyBzb21lIHdlaXJkLCBpbXBsaWNpdCBmaWxlIHVwbG9hZCBzdXBwb3J0XG5cdFx0Ly8gdGhhdCBvbmx5IHdvcmtzIGlmIHlvdSBkb24ndCBzZXQgYHR5cGVgLlxuXHRcdGlmICh0aGlzLl90eXBlICYmIHRoaXMuX3R5cGUgIT09ICdmb3JtLWRhdGEnKSB7XG5cdFx0XHRyZXEudHlwZSh0aGlzLl90eXBlKTtcblx0XHR9XG5cblx0XHRyZXEuc2VuZChwb3N0UGFyYW1zKTtcblx0fVxuXG5cdHN3aXRjaCAodGhpcy5fbWV0aG9kKSB7XG5cdFx0Y2FzZSAnR0VUJzpcblx0XHRjYXNlICdIRUFEJzpcblx0XHRcdGlmIChoYXNQb3N0UGFyYW1zKSB7XG5cdFx0XHRcdGxvZ2dlci53YXJuaW5nKGBBdHRlbXB0aW5nIGEgJHt0aGlzLl9tZXRob2R9IHJlcXVlc3Qgd2l0aCBQT1NUIGRhdGEgKHVzaW5nIFN1cGVyQWdlbnQncyAuc2VuZCgpIGZ1bmN0aW9uKS4gVGhpcyBtaWdodCByZXN1bHQgaW4gYSBDT1JTIHByZWZsaWdodCByZXF1ZXN0YCk7XG5cdFx0XHR9XG5cdFx0XHRicmVhaztcblxuXHRcdGNhc2UgJ1BPU1QnOlxuXHRcdGNhc2UgJ1BBVENIJzpcblx0XHRjYXNlICdQVVQnOlxuXHRcdFx0aWYgKGhhc1F1ZXJ5UGFyYW1zKSB7XG5cdFx0XHRcdGxvZ2dlci5pbmZvKGBBdHRlbXB0aW5nIGEgJHt0aGlzLl9tZXRob2R9IHJlcXVlc3Qgd2l0aCBxdWVyeSBkYXRhICh1c2luZyBTdXBlckFnZW50J3MgLnF1ZXJ5KCkgZnVuY3Rpb24pLiBUaGlzIG1pZ2h0IG5vdCBiZSB3aGF0IHlvdSB3YW50LmApO1xuXHRcdFx0fVxuXHRcdFx0YnJlYWs7XG5cdH1cblxuXHRpZiAodGhpcy5fdGltZW91dCkge1xuXHRcdHJlcS50aW1lb3V0KHRoaXMuX3RpbWVvdXQpO1xuXHR9XG5cblx0Ly8gY2FjaGUgdGhlIGludGVybmFsIHJlcXVlc3QsIHNvIHRoYXQgd2UgY2FuIGNhbmNlbCBpdFxuXHQvLyBpZiBuZWNlc3NhcnkgKHNlZTogYGFib3J0KClgKVxuXHR0aGlzLl9zdXBlcmFnZW50UmVxID0gcmVxO1xuXG5cdHJldHVybiByZXE7XG59XG5cblJlcXVlc3QucHJvdG90eXBlLl9idWlsZFVybCA9IGZ1bmN0aW9uICgpIHtcblx0Ly8gb25seSBtb2RpZnkgcmVsYXRpdmUgcGF0aHNcblx0aWYgKHRoaXMuX3VybFByZWZpeCAmJiB0aGlzLl91cmxQYXRoLmNoYXJBdCgwKSA9PT0gJy8nKSB7XG5cdFx0cmV0dXJuIHRoaXMuX3VybFByZWZpeCArIHRoaXMuX3VybFBhdGg7XG5cdH1cblx0cmV0dXJuIHRoaXMuX3VybFBhdGg7XG59XG5cblJlcXVlc3QucHJvdG90eXBlLl9nZXRDYWNoZUFmZmVjdGluZ0RhdGEgPSBmdW5jdGlvbiAoKSB7XG5cdHJldHVybiB7XG5cdFx0dXJsUGF0aDogdGhpcy5fdXJsUGF0aCxcblx0XHRtZXRob2Q6IHRoaXMuX21ldGhvZCxcblx0XHRxdWVyeVBhcmFtczogdGhpcy5fcXVlcnlQYXJhbXMsXG5cdFx0cG9zdFBhcmFtczogdGhpcy5fcG9zdFBhcmFtcyxcblx0XHQvLyBoZWFkZXJzOiB0aGlzLl9oZWFkZXJzLCAvLyBoZWFkZXJzIGFyZSBub3QgaW5jbHVkZWRcblx0XHR0eXBlOiB0aGlzLl90eXBlLFxuXHR9O1xufVxuXG5SZXF1ZXN0LnByb3RvdHlwZS5nZXRQcm90b2NvbCA9IGZ1bmN0aW9uKCl7XG5cblx0Ly8gUmV0dXJucyB1bmRlZmluZWQgaWYgbm8gcHJvdG9jb2wgZm91bmQuXG5cdHJldHVybiAodGhpcy5fYnVpbGRVcmwoKS5tYXRjaCgvXiguKz8pOi8pfHxbXSlbMV07XG59XG5cbi8qKlxuICogQ29udmVuaWVuY2UgbWV0aG9kIHRvIHRyZWF0IHRoZSByZXF1ZXN0IGFzIHRoZW4tYWJsZSAocHJvbWlzZS1saWtlKS5cbiAqIFRoaXMgaXMgc2hvcnRoYW5kIGZvciB0aGUgc2ltcGxlIGNhc2UuIElmIHlvdSB3YW50IGFjY2VzcyB0byB0aGUgZnVsbFxuICogcG93ZXIgb2YgdGhlIHVuZGVybHlpbmcgcHJvbWlzZSBsaWJyYXJ5LCB1c2UgYFJlcXVlc3QuYXNQcm9taXNlKClgXG4gKi9cblJlcXVlc3QucHJvdG90eXBlLnRoZW4gPSBmdW5jdGlvbiAoLyphcmd1bWVudHMqLykge1xuXHR2YXIgcHJvbWlzZSA9IHRoaXMuYXNQcm9taXNlKCk7XG5cdHJldHVybiBwcm9taXNlLnRoZW4uYXBwbHkocHJvbWlzZSwgYXJndW1lbnRzKTtcbn07XG5cbi8qKlxuICogQ29udmVuaWVuY2UgbWV0aG9kIHdyYXBwaW5nIGAuZW5kKClgIGFuZCByZXR1cm5pbmcgYSBwcm9taXNlXG4gKiB0aGF0IGlzIHJlc29sdmVkIGlmIHRoZSByZXF1ZXN0IGlzIHN1Y2Nlc3NmdWwsIGFuZCByZWplY3RlZCBpZlxuICogdGhlIHJlcXVlc3QgcmVzdWx0cyBpbiBhbiBlcnJvci5cbiAqL1xuUmVxdWVzdC5wcm90b3R5cGUuYXNQcm9taXNlID0gZnVuY3Rpb24gKCkge1xuXHR2YXIgZGZkID0gUS5kZWZlcigpO1xuXHRkZmQucHJvbWlzZS5jYXRjaChsb2dSZXF1ZXN0RXJyb3IuYmluZCh0aGlzKSk7XG5cdHRoaXMuZW5kKGRmZC5tYWtlTm9kZVJlc29sdmVyKCkpO1xuXHRyZXR1cm4gZGZkLnByb21pc2U7XG59XG5cbi8vIHByaXZhdGUgbWV0aG9kOyAndGhpcycgYm91bmQgdG8gcmVxdWVzdCBvYmplY3RcbmZ1bmN0aW9uIGxvZ1JlcXVlc3RFcnJvcihlcnIpIHtcblxuXHR2YXIge3Jlc3BvbnNlfSA9IGVycjtcblx0aWYgKCFyZXNwb25zZSkge1xuXHRcdGxvZ2dlci53YXJuaW5nKGBSZWFjdFNlcnZlckFnZW50IHJhaXNlZCBleGNlcHRpb24gZm9yIFVSTCAke3RoaXMuX3VybFBhdGh9YCwgZXJyKTtcblx0fSBlbHNlIGlmIChyZXNwb25zZS5ub3RGb3VuZCkge1xuXHRcdC8vIDQwND8gZG9uJ3QgY2FyZSBhYm91dCByZXNwb25zZVxuXHRcdGxvZ2dlci53YXJuaW5nKGBSZXNvdXJjZSBub3QgZm91bmQgb24gc2VydmVyOiAke3RoaXMuX3VybFBhdGh9YCk7XG5cdH0gZWxzZSBpZiAocmVzcG9uc2Uuc2VydmVyRXJyb3IpIHtcblx0XHRsb2dnZXIud2FybmluZyhgUmVjZWl2ZWQgc2VydmVyIGVycm9yIGZvciBVUkwgJHt0aGlzLl91cmxQYXRofWAsIGVycik7XG5cdH0gZWxzZSB7XG5cdFx0bG9nZ2VyLndhcm5pbmcoYFVuZXhwZWN0ZWQgc3RhdHVzIGNvZGUgcmV0dXJuZWQgZm9yIFVSTCAke3RoaXMuX3VybFBhdGh9YCwgZXJyKTtcblx0fVxufVxuXG4vKipcbiAqIE92ZXJyaWRpbmcgc3VwZXJhZ2VudCB1c2UoKSBmdW5jdGlvbiB0byBnaXZlIGEgbW9yZSBkZXNjcmlwdGl2ZVxuICogZXJyb3IgbWVzc2FnZSB0aGFuIGp1c3Qgbm90IGluY2x1ZGluZyBpdCBhbHRvZ2V0aGVyLlxuICovXG5SZXF1ZXN0LnByb3RvdHlwZS51c2UgPSBmdW5jdGlvbiAoKSB7XG5cdHRocm93IG5ldyBFcnJvcihgdXNlKCkgZnVuY3Rpb24gaXMgc3VwZXJzZWRlZCBieSBwbHVnUmVxdWVzdCguLi4pYCk7XG59XG5cbi8qKlxuICogR2V0L1NldCB0aGUgcHJlZml4IHVzZWQgZm9yIHJlbGF0aXZlIFVSTHNcbiAqL1xuUmVxdWVzdC5wcm90b3R5cGUudXJsUHJlZml4ID0gZnVuY3Rpb24gKHVybFByZWZpeCkge1xuXHRpZiAodHlwZW9mIHVybFByZWZpeCA9PT0gJ3VuZGVmaW5lZCcpIHtcblx0XHRyZXR1cm4gdGhpcy5fdXJsUHJlZml4O1xuXHR9XG5cdHRoaXMuX3VybFByZWZpeCA9IHVybFByZWZpeDtcblx0cmV0dXJuIHRoaXM7XG59XG5cbi8qKlxuICogQWJvcnQgdGhlIGFjdGl2ZSByZXF1ZXN0LiBQYXNzZXMgdGhyb3VnaCB0byBzdXBlcmFnZW50J3NcbiAqIGBhYm9ydCgpYCBtZXRob2QuIFNldHMgJ2Fib3J0ZWQnIGZsYWcgb24gdGhpcyByZXF1ZXN0XG4gKi9cblJlcXVlc3QucHJvdG90eXBlLmFib3J0ID0gZnVuY3Rpb24gKCkge1xuXHRpZiAodGhpcy5fc3VwZXJhZ2VudFJlcSkge1xuXHRcdHRoaXMuYWJvcnRlZCA9IHRydWU7XG5cdFx0dGhpcy5fc3VwZXJhZ2VudFJlcS5hYm9ydCgpO1xuXHR9XG5cdHJldHVybiB0aGlzO1xufVxuXG4vKipcbiAqIEVuYWJsZXMgc2F2aW5nIHRoZSAnaGVhZGVyJyBwcm9wZXJ0eSBpbiB0aGUgcmVzcG9uc2UgY2FjaGUuXG4gKiBUaGlzIGlzIGRpc2FibGVkIGJ5IGRlZmF1bHQgdG8gc2F2ZSBzcGFjZSBpbiB0aGUgY2FjaGUuXG4gKi9cblJlcXVlc3QucHJvdG90eXBlLndpdGhIZWFkZXJJblJlc3BvbnNlID0gZnVuY3Rpb24gKCkge1xuXHRpZiAodHlwZW9mIHRoaXMuX2NhY2hlV2hpdGVsaXN0ID09PSAndW5kZWZpbmVkJykge1xuXHRcdHRoaXMuX2NhY2hlV2hpdGVsaXN0ID0gW107XG5cdH1cblx0dGhpcy5fY2FjaGVXaGl0ZWxpc3QucHVzaCgnaGVhZGVyJyk7XG5cdHJldHVybiB0aGlzO1xufVxuXG5cbm1vZHVsZS5leHBvcnRzID0gUmVxdWVzdDtcbiJdfQ==
