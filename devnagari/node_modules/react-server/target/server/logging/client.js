'use strict';

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

/*
 * This is a shim logging module for use in the browser.
 *
 * Our server-side logging library doesn't work client-side.  This just
 * implements the interface with basic output to `console.log`.
 *
 * TODO: For production use we should mimic the interface with NOOPs.
 *
 */

var common = require('./common');

var _console = ['log', 'error', 'warn', 'debug', 'info'].reduce(function (m, v) {
	// IE9 doesn't even _define_ console unless the dev tools are open.
	// IE9 also needs a real function for `apply` to work.
	m[v] = typeof console === 'undefined' ? function () {} : Function.prototype.bind.call(console[v] || console.log, console);
	return m;
}, {});

var lvl_map = {
	emergency: 'error',
	alert: 'error',
	critical: 'error',
	error: 'error',
	warning: 'warn',
	notice: 'warn',
	debug: 'debug',
	info: 'info'
};
var clog = function clog(lvl) {
	return _console[lvl_map[lvl] || 'log'];
};

// IE9 also doesn't support color.
var monochrome = _typeof(_console.log) == "object";

// We don't chain our transports in the same way as winston client-side, but
// we'll conform more-or-less to winston's interface for the `log` method for
// consistency's sake.  This means passing a function as the fourth argument.
// We'll use a noop.
var noop = function noop() {};

var transportQueue = [];

var transportTimer;

function runTransports() {
	var batch = transportQueue;
	transportQueue = [];
	transportTimer = null;
	for (var i = 0; i < batch.length; i++) {
		var _batch$i = _slicedToArray(batch[i], 4),
		    transport = _batch$i[0],
		    level = _batch$i[1],
		    msg = _batch$i[2],
		    meta = _batch$i[3];

		transport.log(level, msg, meta, noop);
	}
}

function scheduleTransport(tuple) {
	transportQueue.push(tuple);
	if (!transportTimer) {
		transportTimer = setTimeout(runTransports, 0);
	}
}

var makeLogger = function makeLogger(group, opts) {
	var config = common.config[group];

	var logger = {
		opts: opts,
		name: opts.name,
		level: config.baseLevel,
		log: function log(level, msg, meta) {

			if (this.transports.length) {
				this.transports.forEach(function (transport) {
					if (config.levels[level] > config.levels[transport.level]) return;
					scheduleTransport([transport, level, msg, meta]);
				});
			}

			if (config.levels[level] > config.levels[this.level]) return;

			// We want an array of arguments to apply to
			// `console.log` so we don't trail an `undefined` when
			// `meta` isn't passed.
			var args = [msg];
			if (meta !== void 0) args.push(meta);

			clog(level).apply(_console, (monochrome ? [level + ': [' + opts.name + ']'] : ['%c' + level + '%c: [%c' + opts.name + '%c]', 'color: ' + config.colors[level], 'color: black', 'color: ' + opts.color.client, 'color: black']).concat(args));
		},
		transports: [],
		add: function add(transport, opts) {
			this.transports.push(new transport(opts));
		},
		stack: common.stack
	};

	Object.keys(config.levels).forEach(function (level) {
		// note that this has to be an ES-5 style function and cannot be an arrow function
		// because arguments doesn't bind to the arrow function's arguments; it would bind
		// to makeLogger's arguments.
		logger[level] = function (a, b, c) {
			logger.log(level, a, b, c);
		};
	});

	(config.extraTransports || []).forEach(function (transport) {
		return logger.add(transport, opts);
	});

	return logger;
};

var getLogger = common.makeGetLogger(makeLogger);

var setLevel = function setLevel(group, level) {

	// Update level for any future loggers.
	common.config[group].baseLevel = level;

	common.forEachLogger(function (logger, loggerGroup) {
		if (loggerGroup === group) logger.level = level;
	});
};

var addTransport = function addTransport(group, transport) {

	if (!common.config[group].extraTransports) {
		common.config[group].extraTransports = [];
	}

	common.config[group].extraTransports.push(transport);

	common.forEachLogger(function (logger, loggerGroup) {
		if (loggerGroup === group) logger.add(transport, logger.opts);
	});
};

module.exports = { getLogger: getLogger, setLevel: setLevel, addTransport: addTransport };
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2dpbmcvY2xpZW50LmpzIl0sIm5hbWVzIjpbImNvbW1vbiIsInJlcXVpcmUiLCJfY29uc29sZSIsInJlZHVjZSIsIm0iLCJ2IiwiY29uc29sZSIsIkZ1bmN0aW9uIiwicHJvdG90eXBlIiwiYmluZCIsImNhbGwiLCJsb2ciLCJsdmxfbWFwIiwiZW1lcmdlbmN5IiwiYWxlcnQiLCJjcml0aWNhbCIsImVycm9yIiwid2FybmluZyIsIm5vdGljZSIsImRlYnVnIiwiaW5mbyIsImNsb2ciLCJsdmwiLCJtb25vY2hyb21lIiwibm9vcCIsInRyYW5zcG9ydFF1ZXVlIiwidHJhbnNwb3J0VGltZXIiLCJydW5UcmFuc3BvcnRzIiwiYmF0Y2giLCJpIiwibGVuZ3RoIiwidHJhbnNwb3J0IiwibGV2ZWwiLCJtc2ciLCJtZXRhIiwic2NoZWR1bGVUcmFuc3BvcnQiLCJ0dXBsZSIsInB1c2giLCJzZXRUaW1lb3V0IiwibWFrZUxvZ2dlciIsImdyb3VwIiwib3B0cyIsImNvbmZpZyIsImxvZ2dlciIsIm5hbWUiLCJiYXNlTGV2ZWwiLCJ0cmFuc3BvcnRzIiwiZm9yRWFjaCIsImxldmVscyIsImFyZ3MiLCJhcHBseSIsImNvbG9ycyIsImNvbG9yIiwiY2xpZW50IiwiY29uY2F0IiwiYWRkIiwic3RhY2siLCJPYmplY3QiLCJrZXlzIiwiYSIsImIiLCJjIiwiZXh0cmFUcmFuc3BvcnRzIiwiZ2V0TG9nZ2VyIiwibWFrZUdldExvZ2dlciIsInNldExldmVsIiwiZm9yRWFjaExvZ2dlciIsImxvZ2dlckdyb3VwIiwiYWRkVHJhbnNwb3J0IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7Ozs7Ozs7Ozs7QUFVQSxJQUFJQSxTQUFTQyxRQUFRLFVBQVIsQ0FBYjs7QUFFQSxJQUFJQyxXQUFXLENBQUMsS0FBRCxFQUFPLE9BQVAsRUFBZSxNQUFmLEVBQXNCLE9BQXRCLEVBQThCLE1BQTlCLEVBQXNDQyxNQUF0QyxDQUE2QyxVQUFDQyxDQUFELEVB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QSxRQUFXLENBQVN6QixLQUFULEVBQWdCUixLQUFoQixFQUFzQjs7QUFFcEM7QUFDQWhDLFFBQU8wQyxNQUFQLENBQWNGLEtBQWQsRUFBcUJLLFNBQXJCLEdBQWlDYixLQUFqQzs7QUFFQWhDLFFBQU9rRSxhQUFQLENBQXFCLFVBQUN2QixNQUFELEVBQVN3QixXQUFULEVBQXlCO0FBQzdDLE1BQUlBLGdCQUFnQjNCLEtBQXBCLEVBQTJCRyxPQUFPWCxLQUFQLEdBQWVBLEtBQWY7QUFDM0IsRUFGRDtBQUdBLENBUkQ7O0FBVUEsSUFBSW9DLGVBQWUsU0FBZkEsWUFBZSxDQUFTNUIsS0FBVCxFQUFnQlQsU0FBaEIsRUFBMEI7O0FBRTVDLEtBQUksQ0FBQy9CLE9BQU8wQyxNQUFQLENBQWNGLEtBQWQsRUFBcUJzQixlQUExQixFQUEwQztBQUN6QzlELFNBQU8wQyxNQUFQLENBQWNGLEtBQWQsRUFBcUJzQixlQUFyQixHQUF1QyxFQUF2QztBQUNBOztBQUVEOUQsUUFBTzBDLE1BQVAsQ0FBY0YsS0FBZCxFQUFxQnNCLGVBQXJCLENBQXFDekIsSUFBckMsQ0FBMENOLFNBQTFDOztBQUVBL0IsUUFBT2tFLGFBQVAsQ0FBcUIsVUFBQ3ZCLE1BQUQsRUFBU3dCLFdBQVQsRUFBeUI7QUFDN0MsTUFBSUEsZ0JBQWdCM0IsS0FBcEIsRUFBMkJHLE9BQU9ZLEdBQVAsQ0FBV3hCLFNBQVgsRUFBc0JZLE9BQU9GLElBQTdCO0FBQzNCLEVBRkQ7QUFHQSxDQVhEOztBQWFBNEIsT0FBT0MsT0FBUCxHQUFpQixFQUFFUCxvQkFBRixFQUFhRSxrQkFBYixFQUF1QkcsMEJBQXZCLEVBQWpCIiwiZmlsZSI6ImxvZ2dpbmcvY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFRoaXMgaXMgYSBzaGltIGxvZ2dpbmcgbW9kdWxlIGZvciB1c2UgaW4gdGhlIGJyb3dzZXIuXG4gKlxuICogT3VyIHNlcnZlci1zaWRlIGxvZ2dpbmcgbGlicmFyeSBkb2Vzbid0IHdvcmsgY2xpZW50LXNpZGUuICBUaGlzIGp1c3RcbiAqIGltcGxlbWVudHMgdGhlIGludGVyZmFjZSB3aXRoIGJhc2ljIG91dHB1dCB0byBgY29uc29sZS5sb2dgLlxuICpcbiAqIFRPRE86IEZvciBwcm9kdWN0aW9uIHVzZSB3ZSBzaG91bGQgbWltaWMgdGhlIGludGVyZmFjZSB3aXRoIE5PT1BzLlxuICpcbiAqL1xuXG52YXIgY29tbW9uID0gcmVxdWlyZSgnLi9jb21tb24nKVxuXG52YXIgX2NvbnNvbGUgPSBbJ2xvZycsJ2Vycm9yJywnd2FybicsJ2RlYnVnJywnaW5mbyddLnJlZHVjZSgobSx2KSA9PiB7XG5cdC8vIElFOSBkb2Vzbid0IGV2ZW4gX2RlZmluZV8gY29uc29sZSB1bmxlc3MgdGhlIGRldiB0b29scyBhcmUgb3Blbi5cblx0Ly8gSUU5IGFsc28gbmVlZHMgYSByZWFsIGZ1bmN0aW9uIGZvciBgYXBwbHlgIHRvIHdvcmsuXG5cdG1bdl0gPSAodHlwZW9mIGNvbnNvbGUgPT09ICd1bmRlZmluZWQnKVxuXHRcdD8oKSA9PiB7fVxuXHRcdDpGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGVbdl18fGNvbnNvbGUubG9nLCBjb25zb2xlKVxuXHRyZXR1cm4gbTtcbn0sIHt9KTtcblxudmFyIGx2bF9tYXAgPSB7XG5cdGVtZXJnZW5jeSA6ICdlcnJvcicsXG5cdGFsZXJ0ICAgICA6ICdlcnJvcicsXG5cdGNyaXRpY2FsICA6ICdlcnJvcicsXG5cdGVycm9yICAgICA6ICdlcnJvcicsXG5cdHdhcm5pbmcgICA6ICd3YXJuJyxcblx0bm90aWNlICAgIDogJ3dhcm4nLFxuXHRkZWJ1ZyAgICAgOiAnZGVidWcnLFxuXHRpbmZvICAgICAgOiAnaW5mbycsXG59O1xudmFyIGNsb2cgPSBsdmwgPT4gX2NvbnNvbGVbbHZsX21hcFtsdmxdIHx8ICdsb2cnXTtcblxuLy8gSUU5IGFsc28gZG9lc24ndCBzdXBwb3J0IGNvbG9yLlxudmFyIG1vbm9jaHJvbWUgPSB0eXBlb2YgX2NvbnNvbGUubG9nID09IFwib2JqZWN0XCI7XG5cbi8vIFdlIGRvbid0IGNoYWluIG91ciB0cmFuc3BvcnRzIGluIHRoZSBzYW1lIHdheSBhcyB3aW5zdG9uIGNsaWVudC1zaWRlLCBidXRcbi8vIHdlJ2xsIGNvbmZvcm0gbW9yZS1vci1sZXNzIHRvIHdpbnN0b24ncyBpbnRlcmZhY2UgZm9yIHRoZSBgbG9nYCBtZXRob2QgZm9yXG4vLyBjb25zaXN0ZW5jeSdzIHNha2UuICBUaGlzIG1lYW5zIHBhc3NpbmcgYSBmdW5jdGlvbiBhcyB0aGUgZm91cnRoIGFyZ3VtZW50LlxuLy8gV2UnbGwgdXNlIGEgbm9vcC5cbnZhciBub29wID0gKCkgPT4ge307XG5cbnZhciB0cmFuc3BvcnRRdWV1ZSA9IFtdO1xuXG52YXIgdHJhbnNwb3J0VGltZXI7XG5cbmZ1bmN0aW9uIHJ1blRyYW5zcG9ydHMoKSB7XG5cdHZhciBiYXRjaCA9IHRyYW5zcG9ydFF1ZXVlO1xuXHR0cmFuc3BvcnRRdWV1ZSA9IFtdO1xuXHR0cmFuc3BvcnRUaW1lciA9IG51bGw7XG5cdGZvciAodmFyIGkgPSAwOyBpIDwgYmF0Y2gubGVuZ3RoOyBpKyspIHtcblx0XHRjb25zdCBbdHJhbnNwb3J0LCBsZXZlbCwgbXNnLCBtZXRhXSA9IGJhdGNoW2ldO1xuXHRcdHRyYW5zcG9ydC5sb2cobGV2ZWwsIG1zZywgbWV0YSwgbm9vcCk7XG5cdH1cbn1cblxuZnVuY3Rpb24gc2NoZWR1bGVUcmFuc3BvcnQodHVwbGUpIHtcblx0dHJhbnNwb3J0UXVldWUucHVzaCh0dXBsZSk7XG5cdGlmICghdHJhbnNwb3J0VGltZXIpIHtcblx0XHR0cmFuc3BvcnRUaW1lciA9IHNldFRpbWVvdXQocnVuVHJhbnNwb3J0cywgMCk7XG5cdH1cbn1cblxudmFyIG1ha2VMb2dnZXIgPSBmdW5jdGlvbihncm91cCwgb3B0cyl7XG5cdHZhciBjb25maWcgPSBjb21tb24uY29uZmlnW2dyb3VwXVxuXG5cdHZhciBsb2dnZXIgPSB7XG5cdFx0b3B0cyxcblx0XHRuYW1lOiBvcHRzLm5hbWUsXG5cdFx0bGV2ZWw6IGNvbmZpZy5iYXNlTGV2ZWwsXG5cdFx0bG9nOiBmdW5jdGlvbihsZXZlbCwgbXNnLCBtZXRhKXtcblxuXHRcdFx0aWYgKHRoaXMudHJhbnNwb3J0cy5sZW5ndGgpIHtcblx0XHRcdFx0dGhpcy50cmFuc3BvcnRzLmZvckVhY2godHJhbnNwb3J0ID0+IHtcblx0XHRcdFx0XHRpZiAoY29uZmlnLmxldmVsc1tsZXZlbF0gPiBjb25maWcubGV2ZWxzW3RyYW5zcG9ydC5sZXZlbF0pIHJldHVybjtcblx0XHRcdFx0XHRzY2hlZHVsZVRyYW5zcG9ydChbdHJhbnNwb3J0LCBsZXZlbCwgbXNnLCBtZXRhXSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoY29uZmlnLmxldmVsc1tsZXZlbF0gPiBjb25maWcubGV2ZWxzW3RoaXMubGV2ZWxdKSByZXR1cm47XG5cblx0XHRcdC8vIFdlIHdhbnQgYW4gYXJyYXkgb2YgYXJndW1lbnRzIHRvIGFwcGx5IHRvXG5cdFx0XHQvLyBgY29uc29sZS5sb2dgIHNvIHdlIGRvbid0IHRyYWlsIGFuIGB1bmRlZmluZWRgIHdoZW5cblx0XHRcdC8vIGBtZXRhYCBpc24ndCBwYXNzZWQuXG5cdFx0XHR2YXIgYXJncyA9IFttc2ddO1xuXHRcdFx0aWYgKG1ldGEgIT09IHZvaWQgMCkgYXJncy5wdXNoKG1ldGEpO1xuXG5cdFx0XHRjbG9nKGxldmVsKS5hcHBseShcblx0XHRcdFx0X2NvbnNvbGUsXG5cdFx0XHRcdChtb25vY2hyb21lP1tgJHtsZXZlbH06IFske29wdHMubmFtZX1dYF06W1xuXHRcdFx0XHRcdCclYycrbGV2ZWwrJyVjOiBbJWMnK29wdHMubmFtZSsnJWNdJyxcblx0XHRcdFx0XHQnY29sb3I6ICcrY29uZmlnLmNvbG9yc1tsZXZlbF0sXG5cdFx0XHRcdFx0J2NvbG9yOiBibGFjaycsXG5cdFx0XHRcdFx0J2NvbG9yOiAnK29wdHMuY29sb3IuY2xpZW50LFxuXHRcdFx0XHRcdCdjb2xvcjogYmxhY2snLFxuXHRcdFx0XHRdKS5jb25jYXQoYXJncylcblx0XHRcdCk7XG5cdFx0fSxcblx0XHR0cmFuc3BvcnRzOiBbXSxcblx0XHRhZGQ6IGZ1bmN0aW9uKHRyYW5zcG9ydCwgb3B0cyl7XG5cdFx0XHR0aGlzLnRyYW5zcG9ydHMucHVzaChuZXcgdHJhbnNwb3J0KG9wdHMpKTtcblx0XHR9LFxuXHRcdHN0YWNrOiBjb21tb24uc3RhY2ssXG5cdH1cblxuXHRPYmplY3Qua2V5cyhjb25maWcubGV2ZWxzKS5mb3JFYWNoKGxldmVsID0+IHtcblx0XHQvLyBub3RlIHRoYXQgdGhpcyBoYXMgdG8gYmUgYW4gRVMtNSBzdHlsZSBmdW5jdGlvbiBhbmQgY2Fubm90IGJlIGFuIGFycm93IGZ1bmN0aW9uXG5cdFx0Ly8gYmVjYXVzZSBhcmd1bWVudHMgZG9lc24ndCBiaW5kIHRvIHRoZSBhcnJvdyBmdW5jdGlvbidzIGFyZ3VtZW50czsgaXQgd291bGQgYmluZFxuXHRcdC8vIHRvIG1ha2VMb2dnZXIncyBhcmd1bWVudHMuXG5cdFx0bG9nZ2VyW2xldmVsXSA9IGZ1bmN0aW9uKGEsIGIsIGMpe1xuXHRcdFx0bG9nZ2VyLmxvZyhsZXZlbCwgYSwgYiwgYyk7XG5cdFx0fVxuXHR9KTtcblxuXHQoY29uZmlnLmV4dHJhVHJhbnNwb3J0c3x8W10pXG5cdFx0LmZvckVhY2godHJhbnNwb3J0ID0+IGxvZ2dlci5hZGQodHJhbnNwb3J0LCBvcHRzKSk7XG5cblx0cmV0dXJuIGxvZ2dlcjtcbn1cblxudmFyIGdldExvZ2dlciA9IGNvbW1vbi5tYWtlR2V0TG9nZ2VyKG1ha2VMb2dnZXIpO1xuXG52YXIgc2V0TGV2ZWwgPSBmdW5jdGlvbihncm91cCwgbGV2ZWwpe1xuXG5cdC8vIFVwZGF0ZSBsZXZlbCBmb3IgYW55IGZ1dHVyZSBsb2dnZXJzLlxuXHRjb21tb24uY29uZmlnW2dyb3VwXS5iYXNlTGV2ZWwgPSBsZXZlbDtcblxuXHRjb21tb24uZm9yRWFjaExvZ2dlcigobG9nZ2VyLCBsb2dnZXJHcm91cCkgPT4ge1xuXHRcdGlmIChsb2dnZXJHcm91cCA9PT0gZ3JvdXApIGxvZ2dlci5sZXZlbCA9IGxldmVsO1xuXHR9KTtcbn1cblxudmFyIGFkZFRyYW5zcG9ydCA9IGZ1bmN0aW9uKGdyb3VwLCB0cmFuc3BvcnQpe1xuXG5cdGlmICghY29tbW9uLmNvbmZpZ1tncm91cF0uZXh0cmFUcmFuc3BvcnRzKXtcblx0XHRjb21tb24uY29uZmlnW2dyb3VwXS5leHRyYVRyYW5zcG9ydHMgPSBbXTtcblx0fVxuXG5cdGNvbW1vbi5jb25maWdbZ3JvdXBdLmV4dHJhVHJhbnNwb3J0cy5wdXNoKHRyYW5zcG9ydCk7XG5cblx0Y29tbW9uLmZvckVhY2hMb2dnZXIoKGxvZ2dlciwgbG9nZ2VyR3JvdXApID0+IHtcblx0XHRpZiAobG9nZ2VyR3JvdXAgPT09IGdyb3VwKSBsb2dnZXIuYWRkKHRyYW5zcG9ydCwgbG9nZ2VyLm9wdHMpO1xuXHR9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7IGdldExvZ2dlciwgc2V0TGV2ZWwsIGFkZFRyYW5zcG9ydCB9O1xuIl19
