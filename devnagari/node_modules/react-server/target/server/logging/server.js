'use strict';

var winston = require('winston'),
    common = require('./common'),
    _ = {
	mapValues: require("lodash/mapValues"),
	pickBy: require("lodash/pickBy"),
	isPlainObject: require("lodash/isPlainObject"),
	isEmpty: require("lodash/isEmpty"),
	trimStart: require("lodash/trimStart"),
	truncate: require("lodash/truncate")
},
    responseTransport = require('./response');

var makeLogger = function makeLogger(group, opts) {
	var config = common.config[group];
	var fileTransport = new winston.transports.File({
		name: 'file',
		level: config.baseLevel,
		stream: process.stdout,
		json: false,
		timestamp: global.TIMESTAMP_REACT_SERVER_LOG_OUTPUT
	});

	var logger = new winston.Logger({
		transports: [fileTransport, responseTransport.getTransportForGroup(group, opts)]
	});

	// Need to be able to refresh this.
	(logger.updateColorize = function () {
		logger.transports.file.label = colorizeName(opts);
		logger.transports.file.colorize = global.COLORIZE_REACT_SERVER_LOG_OUTPUT;
	})();

	logger.setLevels(config.levels);

	// Only need to look for errors in the main logger's meta.
	if (group === "main") {
		logger.rewriters.push(errorInterceptor);
	}

	logger.stack = common.stack;

	winston.addColors(config.colors);

	// For instantiating new transports later.
	logger.opts = opts;

	(config.extraTransports || []).forEach(function (transport) {
		return logger.add(transport, opts);
	});

	return logger;
};

// Error objects are weird.  Let's turn them into normal objects.
function errorInterceptor(level, msg, meta) {

	if (meta instanceof Error) {
		meta = { error: meta };
	} else if (meta && meta.status && meta.response) {
		meta = { error: meta };
	}

	if (_.isPlainObject(meta)) {
		// allow {error: <someError>} as a valid `meta`
		meta = _.mapValues(meta, normalizeError);
	}
	return meta;
}

// massage the error into a format suitable for logging
function normalizeError(err) {
	if (err instanceof Error) {
		return _.pickBy({
			message: err.message,
			stack: err.stack
		}, function (val) {
			return !_.isEmpty(val);
		});
	}

	if (err && err.status && err.response) {
		// this is probably a superagent error response. we definitely don't
		// want to log the whole thing
		return {
			response: {
				status: err.status,
				responseText: _.truncate(_.trimStart(err.response ? err.response.text : "<no response body>"), 200)
			}
		};
	}

	return err;
}

var getLogger = common.makeGetLogger(makeLogger);

function colorizeName(opts) {

	// Only colorize if we're attached to a terminal.
	if (!global.COLORIZE_REACT_SERVER_LOG_OUTPUT) return opts.name;

	return '\x1B[38;5;' + opts.color.server + 'm' + opts.name + '\x1B[0m';
}

function setLevel(group, level) {

	// Update level for any future loggers.
	common.config[group].baseLevel = level;

	common.forEachLogger(function (logger, loggerGroup) {
		if (loggerGroup === group) logger.transports.file.level = level;
	});
}

function addTransport(group, transport) {

	if (!common.config[group].extraTransports) {
		common.config[group].extraTransports = [];
	}

	common.config[group].extraTransports.push(transport);

	common.forEachLogger(function (logger, loggerGroup) {
		if (loggerGroup === group) logger.add(transport, logger.opts);
	});
}

function addRewriter(group, rewriter) {
	common.forEachLogger(function (logger, loggerGroup) {
		if (loggerGroup === group) logger.rewriters.push(rewriter);
	});
}

function setTimestamp(bool) {

	global.TIMESTAMP_REACT_SERVER_LOG_OUTPUT = bool;

	// Update any loggers that are alredy set up.
	common.forEachLogger(function (logger) {
		if (logger.transports.file) {
			logger.transports.file.timestamp = bool;
		}
	});
}

function setColorize(bool) {

	global.COLORIZE_REACT_SERVER_LOG_OUTPUT = bool;

	// Update any loggers that are alredy set up.
	common.forEachLogger(function (logger) {
		if (logger.updateColorize) {
			logger.updateColorize();
		}
	});
}

// Default is only if we're directly attached to a terminal.
// Can be overridden (This `setColorize` function is exported).
setColorize(process.stdout.isTTY);

// Just the default.
setTimestamp(true);

module.exports = {
	addTransport: addTransport,
	addRewriter: addRewriter,
	getLogger: getLogger,
	setColorize: setColorize,
	setLevel: setLevel,
	setTimestamp: setTimestamp
};
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2dpbmcvc2VydmVyLmpzIl0sIm5hbWVzIjpbIndpbnN0b24iLCJyZXF1aXJlIiwiY29tbW9uIiwiXyIsIm1hcFZhbHVlcyIsInBpY2tCeSIsImlzUGxhaW5PYmplY3QiLCJpc0VtcHR5IiwidHJpbVN0YXJ0IiwidHJ1bmNhdGUiLCJyZXNwb25zZVRyYW5zcG9ydCIsIm1ha2VMb2dnZXIiLCJncm91cCIsIm9wdHMiLCJjb25maWciLCJmaWxlVHJhbnNwb3J0IiwidHJhbnNwb3J0cyIsIkZpbGUiLCJuYW1lIiwibGV2ZWwiLCJiYXNlTGV2ZWwiLCJzdHJlYW0iLCJwcm9jZXNzIiwic3Rkb3V0IiwianNvbiIsInRpbWVzdGFtcCIsImdsb2JhbCIsIlRJTUVTVEFNUF9SRUFDVF9TRVJWRVJfTE9HX09VVFBVVCIsImxvZ2dlciIsIkxvZ2dlciIsImdldFRyYW5zcG9ydEZvckdyb3VwIiwidXBkYXRlQ29sb3JpemUiLCJmaWxlIiwibGFiZWwiLCJjb2xvcml6ZU5hbWUiLCJjb2xvcml6ZSIsIkNPTE9SSVpFX1JFQUNUX1NFUlZFUl9MT0dfT1VUUFVUIiwic2V0TGV2ZWxzIiwibGV2ZWxzIiwicmV3cml0ZXJzIiwicHVzaCIsImVycm9ySW50ZXJjZXB0b3IiLCJzdGFjayIsImFkZENvbG9ycyIsImNvbG9ycyIsImV4dHJhVHJhbnNwb3J0cyIsImZvckVhY2giLCJhZGQiLCJ0cmFuc3BvcnQiLCJtc2ciLCJtZXRhIiwiRXJyb3IiLCJlcnJvciIsInN0YXR1cyIsInJlc3BvbnNlIiwibm9ybWFsaXplRXJyb3IiLCJlcnIiLCJtZXNzYWdlIiwidmFsIiwicmVzcG9uc2VUZXh0IiwidGV4dCIsImdldExvZ2dlciIsIm1ha2VHZXRMb2dnZXIiLCJjb2xvciIsInNlcnZlciIsInNldExldmVsIiwiZm9yRWFjaExvZ2dlciIsImxvZ2dlckdyb3VwIiwiYWRkVHJhbnNwb3J0IiwiYWRkUmV3cml0ZXIiLCJyZXdyaXRlciIsInNldFRpbWVzdGFtcCIsImJvb2wiLCJzZXRD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LGtCQUFVO0FBQzlCLE1BQUl0QyxPQUFPRyxjQUFYLEVBQTJCO0FBQzFCSCxVQUFPRyxjQUFQO0FBQ0E7QUFDRCxFQUpEO0FBS0E7O0FBRUQ7QUFDQTtBQUNBMEMsWUFBWW5ELFFBQVFDLE1BQVIsQ0FBZW1ELEtBQTNCOztBQUVBO0FBQ0FILGFBQWEsSUFBYjs7QUFFQUksT0FBT0MsT0FBUCxHQUFpQjtBQUNoQlIsMkJBRGdCO0FBRWhCQyx5QkFGZ0I7QUFHaEJSLHFCQUhnQjtBQUloQlkseUJBSmdCO0FBS2hCUixtQkFMZ0I7QUFNaEJNO0FBTmdCLENBQWpCIiwiZmlsZSI6ImxvZ2dpbmcvc2VydmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHdpbnN0b24gPSByZXF1aXJlKCd3aW5zdG9uJylcbiwgICBjb21tb24gID0gcmVxdWlyZSgnLi9jb21tb24nKVxuLCAgIF8gPSB7XG5cdG1hcFZhbHVlcyAgICAgOiByZXF1aXJlKFwibG9kYXNoL21hcFZhbHVlc1wiKSxcblx0cGlja0J5ICAgICAgICA6IHJlcXVpcmUoXCJsb2Rhc2gvcGlja0J5XCIpLFxuXHRpc1BsYWluT2JqZWN0IDogcmVxdWlyZShcImxvZGFzaC9pc1BsYWluT2JqZWN0XCIpLFxuXHRpc0VtcHR5ICAgICAgIDogcmVxdWlyZShcImxvZGFzaC9pc0VtcHR5XCIpLFxuXHR0cmltU3RhcnQgICAgIDogcmVxdWlyZShcImxvZGFzaC90cmltU3RhcnRcIiksXG5cdHRydW5jYXRlICAgICAgOiByZXF1aXJlKFwibG9kYXNoL3RydW5jYXRlXCIpLFxufVxuLCAgIHJlc3BvbnNlVHJhbnNwb3J0ID0gcmVxdWlyZSgnLi9yZXNwb25zZScpO1xuXG52YXIgbWFrZUxvZ2dlciA9IGZ1bmN0aW9uKGdyb3VwLCBvcHRzKXtcblx0dmFyIGNvbmZpZyA9IGNvbW1vbi5jb25maWdbZ3JvdXBdO1xuXHR2YXIgZmlsZVRyYW5zcG9ydCA9IG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkZpbGUpKHtcblx0XHRuYW1lICAgICAgOiAnZmlsZScsXG5cdFx0bGV2ZWwgICAgIDogY29uZmlnLmJhc2VMZXZlbCxcblx0XHRzdHJlYW0gICAgOiBwcm9jZXNzLnN0ZG91dCxcblx0XHRqc29uICAgICAgOiBmYWxzZSxcblx0XHR0aW1lc3RhbXAgOiBnbG9iYWwuVElNRVNUQU1QX1JFQUNUX1NFUlZFUl9MT0dfT1VUUFVULFxuXHR9KTtcblxuXHR2YXIgbG9nZ2VyID0gbmV3ICh3aW5zdG9uLkxvZ2dlcikoe1xuXHRcdHRyYW5zcG9ydHM6IFtcblx0XHRcdGZpbGVUcmFuc3BvcnQsXG5cdFx0XHRyZXNwb25zZVRyYW5zcG9ydC5nZXRUcmFuc3BvcnRGb3JHcm91cChncm91cCwgb3B0cyksXG5cdFx0XSxcblx0fSk7XG5cblx0Ly8gTmVlZCB0byBiZSBhYmxlIHRvIHJlZnJlc2ggdGhpcy5cblx0KGxvZ2dlci51cGRhdGVDb2xvcml6ZSA9IGZ1bmN0aW9uKCl7XG5cdFx0bG9nZ2VyLnRyYW5zcG9ydHMuZmlsZS5sYWJlbCA9IGNvbG9yaXplTmFtZShvcHRzKTtcblx0XHRsb2dnZXIudHJhbnNwb3J0cy5maWxlLmNvbG9yaXplID0gZ2xvYmFsLkNPTE9SSVpFX1JFQUNUX1NFUlZFUl9MT0dfT1VUUFVUO1xuXHR9KSgpO1xuXG5cdGxvZ2dlci5zZXRMZXZlbHMoY29uZmlnLmxldmVscyk7XG5cblx0Ly8gT25seSBuZWVkIHRvIGxvb2sgZm9yIGVycm9ycyBpbiB0aGUgbWFpbiBsb2dnZXIncyBtZXRhLlxuXHRpZiAoZ3JvdXAgPT09IFwibWFpblwiKSB7XG5cdFx0bG9nZ2VyLnJld3JpdGVycy5wdXNoKGVycm9ySW50ZXJjZXB0b3IpO1xuXHR9XG5cblx0bG9nZ2VyLnN0YWNrID0gY29tbW9uLnN0YWNrO1xuXG5cdHdpbnN0b24uYWRkQ29sb3JzKGNvbmZpZy5jb2xvcnMpO1xuXG5cdC8vIEZvciBpbnN0YW50aWF0aW5nIG5ldyB0cmFuc3BvcnRzIGxhdGVyLlxuXHRsb2dnZXIub3B0cyA9IG9wdHM7XG5cblx0KGNvbmZpZy5leHRyYVRyYW5zcG9ydHN8fFtdKVxuXHRcdC5mb3JFYWNoKHRyYW5zcG9ydCA9PiBsb2dnZXIuYWRkKHRyYW5zcG9ydCwgb3B0cykpO1xuXG5cdHJldHVybiBsb2dnZXI7XG59XG5cbi8vIEVycm9yIG9iamVjdHMgYXJlIHdlaXJkLiAgTGV0J3MgdHVybiB0aGVtIGludG8gbm9ybWFsIG9iamVjdHMuXG5mdW5jdGlvbiBlcnJvckludGVyY2VwdG9yIChsZXZlbCwgbXNnLCBtZXRhKSB7XG5cblx0aWYgKG1ldGEgaW5zdGFuY2VvZiBFcnJvcikge1xuXHRcdG1ldGEgPSB7ZXJyb3I6IG1ldGF9O1xuXHR9IGVsc2UgaWYgKG1ldGEgJiYgbWV0YS5zdGF0dXMgJiYgbWV0YS5yZXNwb25zZSkge1xuXHRcdG1ldGEgPSB7ZXJyb3I6IG1ldGF9O1xuXHR9XG5cblx0aWYgKF8uaXNQbGFpbk9iamVjdChtZXRhKSkge1xuXHRcdC8vIGFsbG93IHtlcnJvcjogPHNvbWVFcnJvcj59IGFzIGEgdmFsaWQgYG1ldGFgXG5cdFx0bWV0YSA9IF8ubWFwVmFsdWVzKG1ldGEsIG5vcm1hbGl6ZUVycm9yKTtcblx0fVxuXHRyZXR1cm4gbWV0YTtcbn1cblxuLy8gbWFzc2FnZSB0aGUgZXJyb3IgaW50byBhIGZvcm1hdCBzdWl0YWJsZSBmb3IgbG9nZ2luZ1xuZnVuY3Rpb24gbm9ybWFsaXplRXJyb3IgKGVycikge1xuXHRpZiAoZXJyIGluc3RhbmNlb2YgRXJyb3IpIHtcblx0XHRyZXR1cm4gXy5waWNrQnkoe1xuXHRcdFx0bWVzc2FnZTogZXJyLm1lc3NhZ2UsXG5cdFx0XHRzdGFjazogZXJyLnN0YWNrLFxuXHRcdH0sIHZhbCA9PiAhXy5pc0VtcHR5KHZhbCkpO1xuXHR9XG5cblx0aWYgKGVyciAmJiBlcnIuc3RhdHVzICYmIGVyci5yZXNwb25zZSkge1xuXHRcdC8vIHRoaXMgaXMgcHJvYmFibHkgYSBzdXBlcmFnZW50IGVycm9yIHJlc3BvbnNlLiB3ZSBkZWZpbml0ZWx5IGRvbid0XG5cdFx0Ly8gd2FudCB0byBsb2cgdGhlIHdob2xlIHRoaW5nXG5cdFx0cmV0dXJuIHtcblx0XHRcdHJlc3BvbnNlOiB7XG5cdFx0XHRcdHN0YXR1czogZXJyLnN0YXR1cyxcblx0XHRcdFx0cmVzcG9uc2VUZXh0OiBfLnRydW5jYXRlKF8udHJpbVN0YXJ0KGVyci5yZXNwb25zZSA/IGVyci5yZXNwb25zZS50ZXh0IDogXCI8bm8gcmVzcG9uc2UgYm9keT5cIiksIDIwMCksXG5cdFx0XHR9LFxuXHRcdH1cblx0fVxuXG5cdHJldHVybiBlcnI7XG59XG5cblxudmFyIGdldExvZ2dlciA9IGNvbW1vbi5tYWtlR2V0TG9nZ2VyKG1ha2VMb2dnZXIpO1xuXG5mdW5jdGlvbiBjb2xvcml6ZU5hbWUob3B0cykge1xuXG5cdC8vIE9ubHkgY29sb3JpemUgaWYgd2UncmUgYXR0YWNoZWQgdG8gYSB0ZXJtaW5hbC5cblx0aWYgKCFnbG9iYWwuQ09MT1JJWkVfUkVBQ1RfU0VSVkVSX0xPR19PVVRQVVQpIHJldHVybiBvcHRzLm5hbWU7XG5cblx0cmV0dXJuIGBcXHgxQlszODs1OyR7b3B0cy5jb2xvci5zZXJ2ZXJ9bSR7b3B0cy5uYW1lfVxceDFCWzBtYDtcbn1cblxuZnVuY3Rpb24gc2V0TGV2ZWwoZ3JvdXAsIGxldmVsKSB7XG5cblx0Ly8gVXBkYXRlIGxldmVsIGZvciBhbnkgZnV0dXJlIGxvZ2dlcnMuXG5cdGNvbW1vbi5jb25maWdbZ3JvdXBdLmJhc2VMZXZlbCA9IGxldmVsO1xuXG5cdGNvbW1vbi5mb3JFYWNoTG9nZ2VyKChsb2dnZXIsIGxvZ2dlckdyb3VwKSA9PiB7XG5cdFx0aWYgKGxvZ2dlckdyb3VwID09PSBncm91cCkgbG9nZ2VyLnRyYW5zcG9ydHMuZmlsZS5sZXZlbCA9IGxldmVsO1xuXHR9KTtcbn1cblxuZnVuY3Rpb24gYWRkVHJhbnNwb3J0KGdyb3VwLCB0cmFuc3BvcnQpIHtcblxuXHRpZiAoIWNvbW1vbi5jb25maWdbZ3JvdXBdLmV4dHJhVHJhbnNwb3J0cyl7XG5cdFx0Y29tbW9uLmNvbmZpZ1tncm91cF0uZXh0cmFUcmFuc3BvcnRzID0gW107XG5cdH1cblxuXHRjb21tb24uY29uZmlnW2dyb3VwXS5leHRyYVRyYW5zcG9ydHMucHVzaCh0cmFuc3BvcnQpO1xuXG5cdGNvbW1vbi5mb3JFYWNoTG9nZ2VyKChsb2dnZXIsIGxvZ2dlckdyb3VwKSA9PiB7XG5cdFx0aWYgKGxvZ2dlckdyb3VwID09PSBncm91cCkgbG9nZ2VyLmFkZCh0cmFuc3BvcnQsIGxvZ2dlci5vcHRzKTtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIGFkZFJld3JpdGVyKGdyb3VwLCByZXdyaXRlcikge1xuXHRjb21tb24uZm9yRWFjaExvZ2dlcigobG9nZ2VyLCBsb2dnZXJHcm91cCkgPT4ge1xuXHRcdGlmIChsb2dnZXJHcm91cCA9PT0gZ3JvdXApIGxvZ2dlci5yZXdyaXRlcnMucHVzaChyZXdyaXRlcik7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBzZXRUaW1lc3RhbXAoYm9vbCkge1xuXG5cdGdsb2JhbC5USU1FU1RBTVBfUkVBQ1RfU0VSVkVSX0xPR19PVVRQVVQgPSBib29sO1xuXG5cdC8vIFVwZGF0ZSBhbnkgbG9nZ2VycyB0aGF0IGFyZSBhbHJlZHkgc2V0IHVwLlxuXHRjb21tb24uZm9yRWFjaExvZ2dlcihsb2dnZXIgPT4ge1xuXHRcdGlmIChsb2dnZXIudHJhbnNwb3J0cy5maWxlKSB7XG5cdFx0XHRsb2dnZXIudHJhbnNwb3J0cy5maWxlLnRpbWVzdGFtcCA9IGJvb2w7XG5cdFx0fVxuXHR9KTtcbn1cblxuZnVuY3Rpb24gc2V0Q29sb3JpemUoYm9vbCkge1xuXG5cdGdsb2JhbC5DT0xPUklaRV9SRUFDVF9TRVJWRVJfTE9HX09VVFBVVCA9IGJvb2w7XG5cblx0Ly8gVXBkYXRlIGFueSBsb2dnZXJzIHRoYXQgYXJlIGFscmVkeSBzZXQgdXAuXG5cdGNvbW1vbi5mb3JFYWNoTG9nZ2VyKGxvZ2dlciA9PiB7XG5cdFx0aWYgKGxvZ2dlci51cGRhdGVDb2xvcml6ZSkge1xuXHRcdFx0bG9nZ2VyLnVwZGF0ZUNvbG9yaXplKCk7XG5cdFx0fVxuXHR9KTtcbn1cblxuLy8gRGVmYXVsdCBpcyBvbmx5IGlmIHdlJ3JlIGRpcmVjdGx5IGF0dGFjaGVkIHRvIGEgdGVybWluYWwuXG4vLyBDYW4gYmUgb3ZlcnJpZGRlbiAoVGhpcyBgc2V0Q29sb3JpemVgIGZ1bmN0aW9uIGlzIGV4cG9ydGVkKS5cbnNldENvbG9yaXplKHByb2Nlc3Muc3Rkb3V0LmlzVFRZKTtcblxuLy8gSnVzdCB0aGUgZGVmYXVsdC5cbnNldFRpbWVzdGFtcCh0cnVlKTtcblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cdGFkZFRyYW5zcG9ydCxcblx0YWRkUmV3cml0ZXIsXG5cdGdldExvZ2dlcixcblx0c2V0Q29sb3JpemUsXG5cdHNldExldmVsLFxuXHRzZXRUaW1lc3RhbXAsXG59O1xuIl19
